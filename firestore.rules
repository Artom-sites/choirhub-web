rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions (Claims-Based, 0 Extra Reads) ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Claims structure: { choirs: { "choirId": "role" }, superAdmin?: true }
    // Set by syncUserClaims() in Cloud Functions after join/leave/role-change.

    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.superAdmin == true;
    }

    // Check if user is a member of the choir (any role)
    function isMemberOfChoir(choirId) {
      return isSignedIn() && choirId in request.auth.token.choirs;
    }

    // Check if user has admin/regent/head role for the choir
    function isChoirAdmin(choirId) {
      return isMemberOfChoir(choirId) && 
             request.auth.token.choirs[choirId] in ['admin', 'regent', 'head'];
    }

    // --- Collection Rules ---

    // 1. Users Collection
    match /users/{userId} {
      // Private: Only owner or SuperAdmin can read/write
      allow read, write: if request.auth.uid == userId || isSuperAdmin();
    }

    // 2. Choirs Collection
    match /choirs/{choirId} {
      allow read: if isMemberOfChoir(choirId) || isSuperAdmin();
      allow create: if isSignedIn();
      allow update: if isChoirAdmin(choirId) || isSuperAdmin();
      allow delete: if isSuperAdmin();

      // Songs (choir repertoire)
      match /songs/{songId} {
        allow read: if isMemberOfChoir(choirId);
        allow write: if isChoirAdmin(choirId) || isSuperAdmin();
      }
      
      // Local Songs (choir private)
      match /local_songs/{songId} {
        allow read: if isMemberOfChoir(choirId);
        allow write: if isChoirAdmin(choirId) || isSuperAdmin();
      }

      // Services
      match /services/{serviceId} {
        allow read: if isMemberOfChoir(choirId);
        allow create, delete: if isChoirAdmin(choirId) || isSuperAdmin();
        // Members can update their own attendance (confirmedMembers/absentMembers only)
        allow update: if isChoirAdmin(choirId) || isSuperAdmin() || (
          isMemberOfChoir(choirId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['confirmedMembers', 'absentMembers'])
        );
      }

      // Notifications
      match /notifications/{notificationId} {
        allow read: if isMemberOfChoir(choirId);
        allow create: if isChoirAdmin(choirId) || isSuperAdmin();
        // Members can mark notifications as read (readBy field)
        allow update: if isMemberOfChoir(choirId);
      }
      
      // Members subcollection (if used)
      match /members/{memberId} {
        allow read: if isMemberOfChoir(choirId);
        allow write: if isChoirAdmin(choirId) || isSuperAdmin();
      }
    }

    // 3. Global Songs (Public Archive)
    match /global_songs/{songId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    // 4. MSC Catalog (approved songs destination)
    match /mscCatalog/{songId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    // 5. Pending Songs (Community Submissions)
    match /pending_songs/{songId} {
      allow create: if isSignedIn();
      // Submitter can read their own; super admin can read all
      allow read: if isSuperAdmin() || (isSignedIn() && resource.data.submittedBy == request.auth.uid);
      allow update, delete: if isSuperAdmin();
    }
  }
}
